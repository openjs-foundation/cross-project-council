name: CPC Working Session Agenda

on:
  schedule:
    # Runs daily at 3am PT (11am UTC)
    - cron: "0 11 * * *"
  workflow_dispatch:

jobs:
  create-agenda:
    runs-on: ubuntu-latest
    steps:
      - name: Check iCal for CPC Working Session meeting occuring today
        id: check-meeting
        run: |
          # Fetch the iCal feed
          ICAL_URL="https://webcal.prod.itx.linuxfoundation.org/lfx/a0941000002wBygAAE"
          HTTPS_URL="${ICAL_URL/webcal:/https:}"

          echo "Fetching calendar from: $HTTPS_URL"
          curl -sL "$HTTPS_URL" > /tmp/calendar_raw.ics

          # Unfold iCal lines (lines starting with space are continuations)
          perl -0777 -pe 's/\r?\n[ \t]//g' /tmp/calendar_raw.ics > /tmp/calendar.ics

          # Get today's date
          TODAY=$(date +%Y%m%d)
          TODAY_DISPLAY=$(date +%Y-%m-%d)
          echo "Checking for CPC working session on: $TODAY_DISPLAY"

          MEETING_FOUND="false"
          ZOOM_LINK=""
          PASSCODE=""
          MEETING_TIME=""

          # Extract events with "CPC working session" (case insensitive) occurring today
          awk -v today="$TODAY" '
          BEGIN { RS="BEGIN:VEVENT"; FS="\n"; ORS="" }
          /[Cc][Pp][Cc] [Ww]orking [Ss]ession/ && $0 ~ "DTSTART[^:]*:" today {
            print "BEGIN:VEVENT" $0
          }
          ' /tmp/calendar.ics > /tmp/cpc_events.ics

          if [ -s /tmp/cpc_events.ics ]; then
            echo "Found CPC working session on $TODAY_DISPLAY"
            MEETING_FOUND="true"

            # Extract Zoom link from LOCATION field
            ZOOM_LINK=$(grep "^LOCATION:" /tmp/cpc_events.ics | grep -oE 'https://zoom-lfx\.platform\.linuxfoundation\.org/meeting/[0-9]+\?password=[a-f0-9-]+' | head -1)

            # If not in LOCATION, try URL field
            if [ -z "$ZOOM_LINK" ]; then
              ZOOM_LINK=$(grep "^URL" /tmp/cpc_events.ics | grep -oE 'https://zoom-lfx\.platform\.linuxfoundation\.org/meeting/[0-9]+\?password=[a-f0-9-]+' | head -1)
            fi

            # Extract passcode from DESCRIPTION
            PASSCODE=$(grep "^DESCRIPTION:" /tmp/cpc_events.ics | sed -n 's/.*Passcode:[[:space:]]*\([0-9]*\).*/\1/p' | head -1)

            # Extract meeting time from DTSTART
            TIME_RAW=$(grep "DTSTART" /tmp/cpc_events.ics | head -1 | sed -n 's/.*T\([0-9]\{4\}\).*/\1/p')
            if [ -n "$TIME_RAW" ]; then
              HOUR=${TIME_RAW:0:2}
              HOUR_12=$((10#$HOUR % 12))
              [ $HOUR_12 -eq 0 ] && HOUR_12=12
              if [ $((10#$HOUR)) -lt 12 ]; then
                AMPM="AM"
              else
                AMPM="PM"
              fi
              MEETING_TIME="${HOUR_12}:00 ${AMPM} UTC"
            else
              MEETING_TIME="See calendar for time"
            fi

            echo "Zoom Link: $ZOOM_LINK"
            echo "Passcode: $PASSCODE"
            echo "Meeting Time: $MEETING_TIME"
          else
            echo "No CPC working session found on $TODAY_DISPLAY"
          fi

          # Output results
          {
            echo "meeting_found=$MEETING_FOUND"
            echo "zoom_link=$ZOOM_LINK"
            echo "passcode=$PASSCODE"
            echo "meeting_time=$MEETING_TIME"
            echo "meeting_date=$TODAY_DISPLAY"
          } >> $GITHUB_OUTPUT

          echo "Meeting found: $MEETING_FOUND"

      - name: Checkout repository
        if: steps.check-meeting.outputs.meeting_found == 'true'
        uses: actions/checkout@v4

      - name: Get issues with cpc-working-session label
        if: steps.check-meeting.outputs.meeting_found == 'true'
        id: get-issues
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'cpc-working-session',
              state: 'open',
              per_page: 100
            });

            let issueList = '';
            if (issues.length === 0) {
              issueList = '_No issues currently labeled for working session discussion._';
            } else {
              issueList = issues.map(issue => {
                return `* ${issue.title} [#${issue.number}](${issue.html_url})`;
              }).join('\n');
            }

            core.setOutput('issue_list', issueList);
            core.setOutput('issue_count', issues.length);

      - name: Create agenda issue
        if: steps.check-meeting.outputs.meeting_found == 'true'
        uses: actions/github-script@v7
        env:
          ZOOM_LINK: ${{ steps.check-meeting.outputs.zoom_link }}
          MEETING_TIME: ${{ steps.check-meeting.outputs.meeting_time }}
          PASSCODE: ${{ steps.check-meeting.outputs.passcode }}
          MEETING_DATE: ${{ steps.check-meeting.outputs.meeting_date }}
          ISSUE_LIST: ${{ steps.get-issues.outputs.issue_list }}
          ISSUE_COUNT: ${{ steps.get-issues.outputs.issue_count }}
        with:
          script: |
            const meetingDate = process.env.MEETING_DATE;
            const zoomLink = process.env.ZOOM_LINK;
            const meetingTime = process.env.MEETING_TIME;
            const passcode = process.env.PASSCODE;
            const issueList = process.env.ISSUE_LIST;
            const issueCount = process.env.ISSUE_COUNT;

            const title = 'CPC Working Session Agenda - ' + meetingDate;

            const bullet = String.fromCharCode(42);
            const lines = [
              '# CPC Working Session - ' + meetingDate,
              '',
              '## Meeting Details',
              '',
              bullet + ' **Date:** ' + meetingDate,
              bullet + ' **Time:** ' + meetingTime,
              bullet + ' **Zoom:** ' + zoomLink,
            ];

            if (passcode) {
              lines.push(bullet + ' **Passcode:** ' + passcode);
            }

            lines.push(bullet + ' **Calendar:** https://calendar.openjsf.org');
            lines.push('');
            lines.push('## Working Session Agenda Items');
            lines.push('');
            lines.push('The following issues are labeled with `cpc-working-session` for discussion:');
            lines.push('');
            lines.push(issueList);
            lines.push('');
            lines.push('---');
            lines.push('');
            lines.push('_This agenda was automatically generated. To add items to a future working session, apply the `cpc-working-session` label to the relevant issue._');
            lines.push('');
            lines.push('_Issues labeled: ' + issueCount + '_');

            const body = lines.join('\n');

            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['cpc-working-session-agenda']
            });

            console.log('Created issue #' + issue.number + ': ' + issue.title);
            console.log('URL: ' + issue.html_url);
